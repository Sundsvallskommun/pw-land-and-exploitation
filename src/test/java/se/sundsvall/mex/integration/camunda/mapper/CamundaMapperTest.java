package se.sundsvall.mex.integration.camunda.mapper;

import static java.util.Map.entry;
import static org.apache.commons.lang3.StringUtils.isEmpty;
import static org.assertj.core.api.Assertions.assertThat;
import static se.sundsvall.mex.Constants.CAMUNDA_VARIABLE_CASE_NUMBER;
import static se.sundsvall.mex.Constants.CAMUNDA_VARIABLE_PHASE_ACTION;
import static se.sundsvall.mex.Constants.CAMUNDA_VARIABLE_REQUEST_ID;
import static se.sundsvall.mex.Constants.PHASE_ACTION_UNKNOWN;

import java.util.Map;

import org.apache.commons.rng.simple.RandomSource;
import org.camunda.bpm.engine.variable.type.ValueType;
import org.junit.jupiter.api.Test;

import generated.se.sundsvall.camunda.VariableValueDto;
import se.sundsvall.dept44.requestid.RequestId;

class CamundaMapperTest {

	@Test
	void toStartProcessInstanceDto() {

		final var caseNumber = RandomSource.JSF_64.create().nextLong();

		if (isEmpty(RequestId.get())) {
			RequestId.init();
		}

		final var dto = CamundaMapper.toStartProcessInstanceDto(caseNumber);

		assertThat(dto.getBusinessKey()).isEqualTo(String.valueOf(caseNumber));
		assertThat(dto.getVariables().entrySet()).containsExactlyInAnyOrder(
			entry(CAMUNDA_VARIABLE_PHASE_ACTION, new VariableValueDto()
				.type(ValueType.STRING.getName())
				.value(PHASE_ACTION_UNKNOWN)),
			entry(CAMUNDA_VARIABLE_CASE_NUMBER, new VariableValueDto()
				.type(ValueType.LONG.getName())
				.value(caseNumber)),
			entry(CAMUNDA_VARIABLE_REQUEST_ID, new VariableValueDto()
				.type(ValueType.STRING.getName())
				.value(RequestId.get())));
	}

	@Test
	void toVariableValueDto() {
		final var value = "value";

		final var dto = CamundaMapper.toVariableValueDto(ValueType.STRING, value);

		assertThat(dto.getType()).isEqualTo(ValueType.STRING.getName());
		assertThat(dto.getValue()).isEqualTo(value);
	}

	@Test
	void toPatchVariablesDto() {
		final var key = "key";
		final var value = CamundaMapper.toVariableValueDto(ValueType.STRING, "value");
		final var dto = CamundaMapper.toPatchVariablesDto(Map.of(key, value));

		assertThat(dto.getDeletions()).isNullOrEmpty();
		assertThat(dto.getModifications()).hasSize(1).containsExactly(entry(key, value));
	}
}
