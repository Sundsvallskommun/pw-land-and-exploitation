package se.sundsvall.mex.businesslogic.worker;

import static java.util.Optional.ofNullable;
import static se.sundsvall.mex.Constants.CAMUNDA_VARIABLE_CASE_NUMBER;
import static se.sundsvall.mex.Constants.CAMUNDA_VARIABLE_REQUEST_ID;
import static se.sundsvall.mex.Constants.CASEDATA_KEY_PHASE_ACTION;
import static se.sundsvall.mex.Constants.CASEDATA_KEY_PHASE_STATUS;
import static se.sundsvall.mex.Constants.FALSE;
import static se.sundsvall.mex.Constants.PHASE_ACTION_CANCEL;
import static se.sundsvall.mex.Constants.UPDATE_AVAILABLE;
import static se.sundsvall.mex.integration.casedata.mapper.CaseDataMapper.toPatchErrand;

import java.util.Optional;

import org.camunda.bpm.client.task.ExternalTask;
import org.camunda.bpm.client.task.ExternalTaskHandler;
import org.camunda.bpm.client.task.ExternalTaskService;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import generated.se.sundsvall.camunda.VariableValueDto;
import generated.se.sundsvall.casedata.ErrandDTO;
import se.sundsvall.dept44.requestid.RequestId;
import se.sundsvall.mex.businesslogic.handler.FailureHandler;
import se.sundsvall.mex.integration.camunda.CamundaClient;
import se.sundsvall.mex.integration.casedata.CaseDataClient;

public abstract class AbstractWorker implements ExternalTaskHandler {
	private final Logger logger;

	private final CamundaClient camundaClient;

	protected final CaseDataClient caseDataClient;

	protected final FailureHandler failureHandler;

	protected AbstractWorker(CamundaClient camundaClient, CaseDataClient caseDataClient, FailureHandler failureHandler) {
		this.logger = LoggerFactory.getLogger(getClass());
		this.camundaClient = camundaClient;
		this.caseDataClient = caseDataClient;
		this.failureHandler = failureHandler;
	}

	protected void clearUpdateAvailable(ExternalTask externalTask) {
		/*
		 * Clearing process variable has to be a blocking operation.
		 * Using ExternalTaskService.setVariables() will not work without creating race conditions.
		 */
		setProcessInstanceVariable(externalTask, UPDATE_AVAILABLE, FALSE);
	}

	protected void setProcessInstanceVariable(ExternalTask externalTask, String variableName, VariableValueDto variableValue) {
		camundaClient.setProcessInstanceVariable(externalTask.getProcessInstanceId(), variableName, variableValue);
	}

	protected ErrandDTO getErrand(ExternalTask externalTask) {
		return caseDataClient.getErrandById(externalTask.getVariable(CAMUNDA_VARIABLE_CASE_NUMBER));
	}

	protected void logInfo(String msg, Object... arguments) {
		logger.info(msg, arguments);
	}

	protected void logException(ExternalTask externalTask, Exception exception) {
		logger.error("Exception occurred in {} for task with id {} and businesskey {}", this.getClass().getSimpleName(), externalTask.getId(), externalTask.getBusinessKey(), exception);
	}

	protected boolean isCancelRequested(ErrandDTO errand) {
		final var isCancel = ofNullable(errand.getExtraParameters())
			.map(extraParameters -> extraParameters.get(CASEDATA_KEY_PHASE_ACTION))
			.filter(phaseAction -> phaseAction.equals(PHASE_ACTION_CANCEL))
			.isPresent();
		if (isCancel) {
			logInfo("A cancel action has been requested for errand with id {}", errand.getId());
		}
		return isCancel;
	}

	protected void patchPhaseData(final ErrandDTO errand, final String phaseAction, final String phaseStatus) {
		logInfo("Phase action is {}. Setting phase status to {}", phaseAction, phaseStatus);
		caseDataClient.patchErrand(errand.getId(), toPatchErrand(errand.getExternalCaseId(), errand.getPhase(), phaseStatus, phaseAction));
	}

	protected void patchPhaseDataIfNotEqual(final ErrandDTO errand, final String phaseAction, final String phaseStatus) {
		if (!isPhaseStatusEqual(errand, phaseStatus)) {
			patchPhaseData(errand, phaseAction, phaseStatus);
		}
	}

	private boolean isPhaseStatusEqual(final ErrandDTO errand, final String phaseStatus) {
		return phaseStatus.equals(Optional.ofNullable(errand.getExtraParameters())
			.map(extraParameters -> extraParameters.get(CASEDATA_KEY_PHASE_STATUS))
			.orElse(null));
	}

	protected abstract void executeBusinessLogic(ExternalTask externalTask, ExternalTaskService externalTaskService);

	@Override
	public void execute(ExternalTask externalTask, ExternalTaskService externalTaskService) {
		RequestId.init(externalTask.getVariable(CAMUNDA_VARIABLE_REQUEST_ID));
		executeBusinessLogic(externalTask, externalTaskService);
	}
}
