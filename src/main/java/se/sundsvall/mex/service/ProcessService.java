package se.sundsvall.mex.service;

import static se.sundsvall.mex.Constants.CAMUNDA_VARIABLE_MUNICIPALITY_ID;
import static se.sundsvall.mex.Constants.CAMUNDA_VARIABLE_REQUEST_ID;
import static se.sundsvall.mex.Constants.CAMUNDA_VARIABLE_UPDATE_AVAILABLE;
import static se.sundsvall.mex.Constants.PROCESS_KEY;
import static se.sundsvall.mex.Constants.TENANTID;
import static se.sundsvall.mex.Constants.TRUE;
import static se.sundsvall.mex.integration.camunda.mapper.CamundaMapper.toPatchVariablesDto;
import static se.sundsvall.mex.integration.camunda.mapper.CamundaMapper.toStartProcessInstanceDto;
import static se.sundsvall.mex.integration.camunda.mapper.CamundaMapper.toVariableValueDto;

import java.util.Map;

import org.camunda.bpm.engine.variable.type.ValueType;
import org.springframework.stereotype.Service;

import se.sundsvall.dept44.requestid.RequestId;
import se.sundsvall.mex.integration.camunda.CamundaClient;

@Service
public class ProcessService {

	private final CamundaClient camundaClient;

	public ProcessService(CamundaClient camundaClient) {
		this.camundaClient = camundaClient;
	}

	public String startProcess(final String municipalityId, final Long caseNumber) {
		return camundaClient.startProcessWithTenant(PROCESS_KEY, TENANTID, toStartProcessInstanceDto(municipalityId, caseNumber)).getId();
	}

	public void updateProcess(final String municipalityId, final String processInstanceId) {
		final var variablesToUpdate = Map.of(
			CAMUNDA_VARIABLE_MUNICIPALITY_ID, toVariableValueDto(ValueType.STRING, municipalityId),
			CAMUNDA_VARIABLE_UPDATE_AVAILABLE, TRUE,
			CAMUNDA_VARIABLE_REQUEST_ID, toVariableValueDto(ValueType.STRING, RequestId.get()));

		camundaClient.setProcessInstanceVariables(processInstanceId, toPatchVariablesDto(variablesToUpdate));
	}
}
